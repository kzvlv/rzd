{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[calc(100vh-140px)]">

    <div class="lg:w-1/3 flex flex-col bg-white rounded-xl shadow-lg overflow-hidden h-96 lg:h-full">
        <div class="p-4 bg-gray-100 border-b flex justify-between items-center">
            <h2 class="font-bold text-lg text-gray-700">Очередь заезда</h2>
            <button onclick="loadPendingQueue()" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fa-solid fa-rotate"></i> Обновить
            </button>
        </div>

        <div id="queue-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
            <div class="text-center text-gray-500 mt-10">Загрузка очереди...</div>
        </div>
    </div>

    <div class="lg:w-2/3 flex flex-col bg-white rounded-xl shadow-lg h-[600px] lg:h-full overflow-hidden">
        <div class="p-4 bg-white border-b z-10">
            <h1 class="text-2xl font-bold mb-4">Карта занятости</h1>

            <div class="flex flex-col md:flex-row gap-2 items-end">
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500 font-bold">Начало</label>
                    <input type="date" id="start-date" class="w-full p-1 border rounded text-sm">
                </div>
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500 font-bold">Конец</label>
                    <input type="date" id="end-date" class="w-full p-1 border rounded text-sm">
                </div>

                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500 font-bold">Общежитие</label>
                    <select id="dorm-select" class="w-full p-1 border rounded text-sm" onchange="handleDormChange()">
                        {% for dorm in dorms %}
                        <option value="{{ dorm.id }}">{{ dorm.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button id="load-map-btn" class="bg-rzd-red text-white font-bold py-1 px-4 rounded text-sm h-[30px] hover:bg-red-800">
                    Показать
                </button>
            </div>

            <div class="flex gap-4 mt-3 text-xs">
                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-green-500"></div> Свободно</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-red-500"></div> Занято</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-orange-400"></div> Частично</div>
            </div>
        </div>

        <div id="room-selection-container" class="flex-1 overflow-y-auto p-4 space-y-6">
            <div id="rooms-placeholder" class="text-center text-gray-500 py-10">
                Выберите даты и нажмите "Показать".
            </div>
        </div>

        <div class="p-4 bg-gray-100 border-t flex justify-end items-center">
            <div class="text-lg font-bold text-gray-700">
                Проживающих за выбранный период: <span id="total-residents-count" class="text-rzd-red text-2xl ml-2">0</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Глобальные переменные
    let currentDormId = document.getElementById('dorm-select').value;
    const tooltip = document.getElementById('tooltip');

    document.addEventListener('DOMContentLoaded', () => {
        // Установка дат по умолчанию (Сегодня - Сегодня+1)
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        document.getElementById('start-date').valueAsDate = today;
        document.getElementById('end-date').valueAsDate = tomorrow;

        // Загрузка карты и очереди сразу
        loadMap();
        loadPendingQueue();

        document.getElementById('load-map-btn').addEventListener('click', loadMap);
    });

    // При смене общежития обновляем И карту, И очередь
    function handleDormChange() {
        currentDormId = document.getElementById('dorm-select').value;
        loadMap();
        loadPendingQueue();
    }

    // --- ФУНКЦИЯ 1: ЗАГРУЗКА ОЧЕРЕДИ ---
    async function loadPendingQueue() {
        const container = document.getElementById('queue-container');
        container.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> Обновление...</div>';

        try {
            const response = await fetch(`/api/pending-arrivals?dorm_id=${currentDormId}`);
            const bookings = await response.json();

            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-10 flex flex-col items-center">
                        <ion-icon name="checkmark-circle-outline" class="text-4xl text-green-500 mb-2"></ion-icon>
                        <span>Очередь пуста.<br>Все заселены!</span>
                    </div>`;
                return;
            }

            let html = '';
            bookings.forEach(b => {
                // Стиль для просроченных
                const overdueBadge = b.is_overdue
                    ? `<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Опоздание: ${b.days_overdue} дн.</span>`
                    : `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Сегодня</span>`;

                html += `
                <div class="bg-white p-3 rounded shadow border-l-4 ${b.is_overdue ? 'border-red-500' : 'border-blue-500'} relative group hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-gray-800 text-sm">${b.full_name}</h3>
                        ${overdueBadge}
                    </div>

                    <div class="text-xs text-gray-500 mb-2">
                        <div>Комната: <strong>${b.room}</strong> (Место ${b.bed})</div>
                        <div>Орг: ${b.enterprise}</div>
                    </div>

                    <div class="flex gap-2 mt-2">
                        <button onclick="quickAction(${b.id}, 'checkin')" class="flex-1 bg-green-600 text-white text-xs font-bold py-1.5 px-2 rounded hover:bg-green-700 flex items-center justify-center gap-1">
                            <ion-icon name="log-in-outline"></ion-icon> Прибыл
                        </button>
                        <button onclick="quickAction(${b.id}, 'cancel')" class="flex-1 bg-gray-200 text-gray-700 text-xs font-bold py-1.5 px-2 rounded hover:bg-gray-300 flex items-center justify-center gap-1">
                            <ion-icon name="close-circle-outline"></ion-icon> Не явился
                        </button>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = '<div class="text-red-500 text-center">Ошибка загрузки очереди</div>';
            console.error(err);
        }
    }

    // --- ФУНКЦИЯ 2: БЫСТРОЕ ДЕЙСТВИЕ (Заселить/Отменить) ---
    async function quickAction(bookingId, action) {
        if (!confirm(action === 'checkin' ? 'Подтвердить заселение?' : 'Отменить бронь как "Незаезд"?')) return;

        try {
            const response = await fetch('/api/quick-status-change', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ booking_id: bookingId, action: action })
            });
            const res = await response.json();

            if (res.success) {
                // Успех: Обновляем и очередь, и карту
                loadPendingQueue();
                loadMap(); // Чтобы койка сразу стала красной (занятой) или зеленой (свободной)
            } else {
                alert('Ошибка: ' + res.message);
            }
        } catch (err) {
            alert('Ошибка сервера');
        }
    }

    // --- ФУНКЦИЯ 3: ЗАГРУЗКА КАРТЫ ---
    async function loadMap() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const placeholder = document.getElementById('rooms-placeholder');
        const container = document.getElementById('room-selection-container');
        const totalCountEl = document.getElementById('total-residents-count'); // Элемент счетчика

        // Валидация дат
        if (!startDate || !endDate) {
            alert("Пожалуйста, выберите даты начала и конца периода.");
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            alert("Дата начала не может быть позже даты конца.");
            return;
        }

        // Показываем загрузку
        container.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Загрузка карты...</div>';
        totalCountEl.textContent = '...';

        try {
            // Отправляем запрос
            const response = await fetch(`/api/map-for-dates?dorm_id=${currentDormId}&start_date=${startDate}&end_date=${endDate}`);
            const rooms = await response.json();

            if (rooms.error) throw new Error(rooms.error);

            const roomsByCapacity = { 2: [], 3: [] };
            let totalOccupiedCount = 0; // Сбрасываем счетчик

            rooms.forEach(room => {
                let roomHTML = `<div class="bg-white border rounded p-2 text-center shadow-sm">
                                    <h4 class="font-bold text-gray-700 mb-1 text-sm">К.${room.number}</h4>
                                    <div class="flex justify-center gap-1">`;

                room.beds.forEach(bed => {
                    let colorClass = 'bg-green-500 hover:bg-green-600'; // Свободно

                    // Логика цветов и подсчета
                    if (bed.status === 'occupied') {
                        colorClass = 'bg-red-500 hover:bg-red-600'; // Полностью занято
                        totalOccupiedCount++;
                    }
                    else if (bed.status === 'partial') {
                        colorClass = 'bg-orange-400 hover:bg-orange-500'; // Частично
                        totalOccupiedCount++;
                    }
                    else if (bed.status === 'repair') {
                        colorClass = 'bg-gray-400 cursor-not-allowed';
                    }

                    // Тултип
                    let tooltipData = '';
                    if (bed.booking) {
                        tooltipData = `onmouseenter="showMapTooltip(this, '${bed.booking.full_name}', '${bed.booking.start}', '${bed.booking.end}', '${bed.booking.enterprise}')" onmouseleave="hideMapTooltip()"`;
                    }

                    roomHTML += `<div class="w-8 h-6 rounded cursor-pointer ${colorClass} text-white text-xs flex items-center justify-center" ${tooltipData}>${bed.id}</div>`;
                });

                roomHTML += `</div></div>`;

                if (room.capacity === 2) roomsByCapacity[2].push(roomHTML);
                else roomsByCapacity[3].push(roomHTML);
            });

            // Обновляем счетчик на странице
            totalCountEl.textContent = totalOccupiedCount;

            // Рендер HTML
            let finalHTML = '';
            if (roomsByCapacity[3].length > 0) finalHTML += `<div class="mb-4"><h3 class="font-bold border-b mb-2"></h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${roomsByCapacity[3].join('')}</div></div>`;
            if (roomsByCapacity[2].length > 0) finalHTML += `<div><h3 class="font-bold border-b mb-2"></h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${roomsByCapacity[2].join('')}</div></div>`;

            if (finalHTML === '') finalHTML = '<div class="text-center py-10 text-gray-500">Нет данных о комнатах.</div>';

            container.innerHTML = finalHTML;

        } catch (err) {
            container.innerHTML = `<div class="text-red-500 text-center">Ошибка: ${err.message}</div>`;
            totalCountEl.textContent = '0';
        }
    }

    // Тултипы для карты
    function showMapTooltip(el, name, start, end, enterprise) {
        const tooltip = document.getElementById('tooltip');
        tooltip.innerHTML = `
            <strong>${name}</strong><br>
            <span class="text-gray-300 text-xs">${enterprise}</span><br>
            ${start} - ${end}
        `;
        tooltip.classList.remove('hidden');
        const rect = el.getBoundingClientRect();
        tooltip.style.left = (rect.left + window.scrollX) + "px";
        tooltip.style.top = (rect.bottom + window.scrollY + 5) + "px";
    }
    function hideMapTooltip() {
        document.getElementById('tooltip').classList.add('hidden');
    }

</script>
{% endblock %}