{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-8">Панель Администратора</h1>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="space-y-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Создать "Предприятие"</h2>
            <form action="{{ url_for('create_user') }}" method="POST" class="space-y-4">
                <input type="hidden" name="role" value="Enterprise">
                <div>
                    <label>ФИО специалиста</label>
                    <input type="text" name="full_name" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Название предприятия</label>
                    <input type="text" name="enterprise_name" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Телефон</label>
                    <input type="text" name="phone" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Логин</label>
                    <input type="text" name="username" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Пароль</label>
                    <input type="password" name="password" required class="w-full p-2 border rounded">
                </div>
                <button type="submit" class="w-full bg-rzd-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800">Создать</button>
            </form>
            <h3 class="text-xl font-semibold mt-6 mb-2">Список предприятий</h3>
            <div class="max-h-96 overflow-y-auto overflow-x-auto">
                <table class="w-full text-sm min-w-[600px]">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">ФИО</th>
                            <th class="p-2 text-left">Предприятие</th>
                            <th class="p-2 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for e in enterprises %}
                        <tr class="border-b">
                            <td class="p-2">{{ e.full_name }}</td>
                            <td class="p-2">{{ e.enterprise_name }}</td>
                            <td class="p-2">
                                <a href="{{ url_for('edit_user', user_id=e.id) }}" class="text-blue-500 hover:underline">Ред.</a>
                                <form action="{{ url_for('delete_user', user_id=e.id) }}" method="POST" class="inline" onsubmit="return confirm('Вы уверены, что хотите удалить пользователя {{ e.full_name }}?');">
                                    <button type="submit" class="text-red-500 hover:underline">Удал.</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Создать "Коменданта"</h2>
            <form action="{{ url_for('create_user') }}" method="POST" class="space-y-4">
                <input type="hidden" name="role" value="Commandant">
                <div>
                    <label>ФИО</label>
                    <input type="text" name="full_name" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Привязать к общежитию</label>
                    <select name="dorm_id" class="w-full p-2 border rounded">
                        <option value="">Не назначено</option>
                        {% for dorm in dorms %}
                        <option value="{{ dorm.id }}">{{ dorm.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>Телефон</label>
                    <input type="text" name="phone" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Логин</label>
                    <input type="text" name="username" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label>Пароль</label>
                    <input type="password" name="password" required class="w-full p-2 border rounded">
                </div>
                <button type="submit" class="w-full bg-rzd-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800">Создать</button>
            </form>
             <h3 class="text-xl font-semibold mt-6 mb-2">Список комендантов</h3>
            <div class="max-h-96 overflow-y-auto overflow-x-auto">
                <table class="w-full text-sm min-w-[600px]">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">ФИО</th>
                            <th class="p-2 text-left">Общежитие</th>
                            <th class="p-2 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for c in commandants %}
                        <tr class="border-b">
                            <td class="p-2">{{ c.full_name }}</td>
                            <td class="p-2">{{ c.dorm.name if c.dorm else 'Не назначено' }}</td>
                            <td class="p-2">
                                <a href="{{ url_for('edit_user', user_id=c.id) }}" class="text-blue-500 hover:underline">Ред.</a>
                                <form action="{{ url_for('delete_user', user_id=c.id) }}" method="POST" class="inline" onsubmit="return confirm('Вы уверены, что хотите удалить пользователя {{ c.full_name }}?');">
                                    <button type="submit" class="text-red-500 hover:underline">Удал.</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="space-y-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Управление Комнатами</h2>

            <h3 class="text-xl font-semibold mb-4">Добавить новую комнату</h3>
            <form action="{{ url_for('create_room') }}" method="POST" class="space-y-4 mb-6 p-4 border rounded-lg bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label>Общежитие</label>
                        <select name="dorm_id" required class="w-full p-2 border rounded">
                            {% for dorm in dorms %}
                            <option value="{{ dorm.id }}">{{ dorm.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label>Номер комнаты</label>
                        <input type="text" name="room_number" required placeholder="Напр. 101" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label>Кол-во мест</label>
                        <input type="number" name="capacity" required min="1" max="10" placeholder="Напр. 3" class="w-full p-2 border rounded">
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Добавить комнату</button>
            </form>

            <h3 class="text-xl font-semibold mt-6 mb-2">Список комнат</h3>
            <div class="max-h-96 overflow-y-auto overflow-x-auto">
                 <table class="w-full text-sm min-w-[600px]">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Общ.</th>
                            <th class="p-2 text-left">Комната</th>
                            <th class="p-2 text-left">Мест</th>
                            <th class="p-2 text-left">Статус</th>
                            <th class="p-2 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for room in rooms %}
                        <tr class="border-b">
                            <td class="p-2">{{ room.dorm.name }}</td>
                            <td class="p-2">{{ room.room_number }}</td>
                            <td class="p-2">{{ room.capacity }}</td>
                            <td class="p-2">
                                <select class="room-status-select border rounded p-1" data-room-id="{{ room.id }}">
                                    <option value="available" {% if room.status == 'available' %}selected{% endif %}>Доступна</option>
                                    <option value="repair" {% if room.status == 'repair' %}selected{% endif %}>На ремонте</option>
                                </select>
                            </td>
                            <td class="p-2">
                                <form action="{{ url_for('delete_room', room_id=room.id) }}" method="POST" class="inline" onsubmit="return confirm('Вы уверены, что хотите удалить комнату {{ room.room_number }}?');">
                                    <button type="submit" class="text-red-500 hover:underline">Удал.</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Отчеты (Экспорт в Excel)</h2>

            <form action="{{ url_for('download_excel_report') }}" method="GET" class="p-4 border rounded-lg bg-gray-50 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Начало периода</label>
                        <input type="date" name="start_date" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Конец периода</label>
                        <input type="date" name="end_date" required class="w-full p-2 border rounded">
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-4">
                     <input type="checkbox" id="only_active" name="only_active" value="1" checked class="w-4 h-4">
                     <label for="only_active" class="text-sm text-gray-700">Только активные (проживающие и бронь)</label>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition flex justify-center items-center gap-2">
                    <ion-icon name="document-text-outline"></ion-icon> Скачать список (.xlsx)
                </button>
            </form>

            <h2 class="text-2xl font-semibold mb-4">Будущие заезды</h2>
            <div class="max-h-96 overflow-y-auto mb-6">
                <table class="w-full text-sm">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">ФИО</th>
                            <th class="p-2 text-left">Заезд</th>
                            <th class="p-2 text-left">Комната</th>
                            <th class="p-2 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for b in future_bookings %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">
                                <div class="font-bold">{{ b.full_name }}</div>
                                <div class="text-xs text-gray-500">{{ b.enterprise_user.enterprise_name }}</div>
                            </td>
                            <td class="p-2">{{ b.start_date.strftime('%d.%m.%Y') }}</td>
                            <td class="p-2">{{ b.room.dorm.name }} / {{ b.room.room_number }}</td>
                            <td class="p-2 flex items-center gap-3">
                                <a href="{{ url_for('move_booking_page', booking_id=b.id) }}" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                    <ion-icon name="swap-horizontal-outline"></ion-icon> Перем.
                                </a>

                                <form action="{{ url_for('cancel_booking', booking_id=b.id) }}" method="POST" onsubmit="return confirm('Вы уверены, что хотите УДАЛИТЬ бронь для {{ b.full_name }}? Место станет свободным.');">
                                    <button type="submit" class="text-red-600 hover:text-red-800 font-medium flex items-center gap-1">
                                        <ion-icon name="trash-outline"></ion-icon> Отменить
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="4" class="p-2 text-gray-500 text-center">Нет будущих заездов.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold mb-4">История (Текущие проживающие)</h2>
            <div class="max-h-96 overflow-y-auto overflow-x-auto">
                <table class="w-full text-sm min-w-[600px]">
                     <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">ФИО</th>
                            <th class="p-2 text-left">Даты</th>
                            <th class="p-2 text-left">Комната</th>
                            <th class="p-2 text-left">Статус</th>
                            <th class="p-2 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for b in past_bookings %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">{{ b.full_name }}</td>
                            <td class="p-2">{{ b.start_date.strftime('%d.%m') }}-{{ b.end_date.strftime('%d.%m') }}</td>
                            <td class="p-2">{{ b.room.dorm.name }} / {{ b.room.room_number }}</td>
                            <td class="p-2">
                                {% if b.status == 'living' %}
                                    <span class="text-green-600 font-bold">Проживает</span>
                                {% else %}
                                    {{ b.status }}
                                {% endif %}
                            </td>
                            <td class="p-2 flex gap-2 items-center">
                                <a href="{{ url_for('move_booking_page', booking_id=b.id) }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                    <ion-icon name="swap-horizontal-outline"></ion-icon> Перем.
                                </a>

                                {% if b.status == 'living' %}
                                <button onclick="evictGuest({{ b.id }}, '{{ b.full_name }}')"
                                        class="text-red-600 hover:text-red-800 font-medium flex items-center gap-1 ml-2"
                                        title="Выселить досрочно и освободить место">
                                    <ion-icon name="log-out-outline"></ion-icon> Выселить
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                         <tr><td colspan="5" class="p-2 text-gray-500 text-center">Список пуст.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Скрипт для обновления статуса комнаты (для Админа)
document.querySelectorAll('.room-status-select').forEach(select => {
    select.addEventListener('change', async (e) => {
        const roomId = e.target.dataset.roomId;
        const newStatus = e.target.value;

        try {
            const response = await fetch('/api/admin/room-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room_id: roomId, status: newStatus })
            });
            const data = await response.json();
            if(!data.success) alert('Ошибка: ' + data.message);
        } catch (err) {
            alert('Сетевая ошибка: ' + err.message);
        }
    });
});

async function evictGuest(bookingId, name) {
    if (!confirm(`Вы действительно хотите выселить гостя ${name}?\n\nДата выезда будет изменена на СЕГОДНЯ, и место освободится.`)) {
        return;
    }

    try {
        const response = await fetch('/api/evict-early', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ booking_id: bookingId })
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            window.location.reload(); // Перезагружаем страницу, чтобы обновить список
        } else {
            alert('Ошибка: ' + result.message);
        }
    } catch (err) {
        alert('Ошибка сервера: ' + err.message);
    }
}
</script>
{% endblock %}