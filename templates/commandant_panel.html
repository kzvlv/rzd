{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-2">Панель Коменданта</h1>

{% if dorm %}
<h2 class="text-2xl font-semibold mb-6">Общежитие: {{ dorm.name }}</h2>
{% else %}
<h2 class="text-2xl font-semibold mb-6 text-red-600">Общежитие не выбрано.</h2>
{% endif %}

{% if all_dorms and current_user.role == 'Admin' %}
<div class="mb-4">
    <label for="dorm-switcher" class="block text-sm font-medium text-gray-700">Переключиться (только для Админа):</label>
    <select id="dorm-switcher" class="border rounded p-2">
        {% for d in all_dorms %}
        <option value="{{ d.id }}" {% if d.id == dorm.id %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
    </select>
</div>
{% endif %}

<!-- ЧАСТЬ 1: ТЕКУЩЕЕ СОСТОЯНИЕ (КАРТА) -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-8">
    <h2 class="text-2xl font-semibold mb-4">Часть 1: Текущее состояние (Кто где живет СЕЙЧАС)</h2>
    <div class="flex justify-center gap-6 mb-6 flex-wrap bg-gray-50 p-4 rounded-lg">
        <div class="flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-green-500"></div><span class="text-sm">Свободно</span></div>
        <div class="flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-red-500"></div><span class="text-sm">Проживает</span></div>
        <div class="flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-yellow-500"></div><span class="text-sm">Забронировано</span></div>
        <div class="flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-gray-600"></div><span class="text-sm">На ремонте</span></div>
    </div>

    <div id="move-status-bar" class="hidden text-center p-3 rounded-lg bg-blue-100 text-blue-900 border border-blue-200 mb-4 shadow-sm flex flex-wrap items-center justify-center gap-4">
        <div>
            Выбран гость: <strong id="selected-guest-name" class="text-lg"></strong>
        </div>

        <div class="flex gap-2">
            <a href="#" id="move-guest-link" class="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition shadow flex items-center gap-2">
                <ion-icon name="swap-horizontal"></ion-icon> Переместить
            </a>

            <button id="btn-evict-guest" class="bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition shadow flex items-center gap-2">
                <ion-icon name="log-out"></ion-icon> Выселить (Досрочно)
            </button>
        </div>

        <button id="cancel-move" class="text-gray-500 hover:text-gray-700 font-semibold underline text-sm ml-2">
            Отмена
        </button>
    </div>

    <div id="room-selection-container" class="space-y-8">
        <div id="rooms-placeholder" class="text-center text-gray-500 py-10">
            Загрузка комнат...
        </div>
    </div>
</div>

<!-- ЧАСТЬ 2: СПИСОК БУДУЩИХ ЗАЕЗДОВ И УПРАВЛЕНИЕ -->
<div class="bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-semibold mb-4">Часть 2: Будущие заезды (Кто приедет ПОТОМ)</h2>
    <div class="max-h-96 overflow-y-auto overflow-x-auto">
        <table class="w-full text-sm min-w-[600px]">
            <thead class="bg-gray-100 sticky top-0">
                <tr>
                    <th class="p-2 text-left">Дата заезда</th>
                    <th class="p-2 text-left">ФИО</th>
                    <th class="p-2 text-left">Группа</th>
                    <th class="p-2 text-left">Комната/Место</th>
                    <th class="p-2 text-left">Статус</th>
                    <th class="p-2 text-left">Действия</th>
                </tr>
            </thead>
            <tbody>
            {% for b in future_bookings %}
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-2">
                        {{ b.start_date.strftime('%d.%m.%Y') }}
                        <div class="text-xs text-gray-400">по {{ b.end_date.strftime('%d.%m.%Y') }}</div>
                    </td>
                    <td class="p-2 font-bold text-gray-700">{{ b.full_name }}</td>
                    <td class="p-2">{{ b.study_group }}</td>
                    <td class="p-2">К. {{ b.room.room_number }} / М. {{ b.bed_id }}</td>

                    <!-- СТАТУС (Просто текст, не выпадающий список) -->
                    <td class="p-2">
                        {% if b.status == 'booked' %}
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded border border-yellow-300">Бронь</span>
                        {% elif b.status == 'living' %}
                            <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded border border-red-300">Живет</span>
                        {% endif %}
                    </td>

                    <!-- ДЕЙСТВИЯ (Кнопки с подтверждением) -->
                    <td class="p-2">
                        <div class="flex items-center gap-2">
                            <!-- Кнопка ЗАСЕЛИТЬ -->
                            {% if b.status == 'booked' %}
                            <form action="{{ url_for('update_booking_status', booking_id=b.id) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="status" value="living">
                                <button type="submit"
                                        onclick="return confirm('Подтвердите действие:\nЗаселить {{ b.full_name }} в комнату {{ b.room.room_number }}?')"
                                        class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow" title="Заселить">
                                    Заселить
                                </button>
                            </form>
                            {% endif %}

                            <!-- Кнопка ВЫСЕЛИТЬ -->
                            {% if b.status == 'living' %}
                            <form action="{{ url_for('update_booking_status', booking_id=b.id) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="status" value="completed">
                                <button type="submit"
                                        onclick="return confirm('Внимание!\nВыселить гостя {{ b.full_name }}? Это освободит место.')"
                                        class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700 shadow" title="Выселить">
                                    Выселить
                                </button>
                            </form>
                            {% endif %}

                            <!-- Кнопка ПЕРЕМЕСТИТЬ -->
                            <a href="{{ url_for('move_booking_page', booking_id=b.id) }}"
                               class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow flex items-center" title="Переместить">
                                Перем.
                            </a>

                            <!-- Кнопка ОТМЕНИТЬ (Только для брони) -->
                            {% if b.status == 'booked' %}
                            <form action="{{ url_for('update_booking_status', booking_id=b.id) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="status" value="cancelled">
                                <button type="submit"
                                        onclick="return confirm('ОПАСНО: Вы уверены, что хотите ОТМЕНИТЬ бронь для {{ b.full_name }}? Это действие нельзя вернуть.')"
                                        class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 shadow font-bold" title="Отменить бронь">
                                    X
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="6" class="p-4 text-center text-gray-500">Нет будущих заездов.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const DORM_ID = {{ dorm.id|tojson }};
    if (!DORM_ID) return;

    let selectedBookingToMove = null;

    const roomsPlaceholder = document.getElementById('rooms-placeholder');
    const roomSelectionContainer = document.getElementById('room-selection-container');
    const statusBar = document.getElementById('move-status-bar');
    const guestNameEl = document.getElementById('selected-guest-name');
    const cancelMoveBtn = document.getElementById('cancel-move');
    const moveGuestLink = document.getElementById('move-guest-link');
    const btnEvictGuest = document.getElementById('btn-evict-guest'); // Новая кнопка
    const dormSwitcher = document.getElementById('dorm-switcher');
    const tooltip = document.getElementById('tooltip');

    // --- Tooltip Functions ---
    function showTooltip(bedEl, booking) {
        if (!booking) return;
        let content = `
            <strong>${booking.full_name}</strong><br>
            Группа: ${booking.group}<br>
            Предпр: ${booking.enterprise}<br>
            Даты: ${booking.start} - ${booking.end}
        `;
        tooltip.innerHTML = content;
        tooltip.classList.remove('hidden');

        const rect = bedEl.getBoundingClientRect();
        tooltip.style.left = `${rect.left + window.scrollX}px`;
        tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
    }

    function hideTooltip() {
        tooltip.classList.add('hidden');
    }
    // -------------------------

    async function renderDormState(dormId) {
        // (Этот код загрузки карты оставляем как был, он работает хорошо)
        roomsPlaceholder.style.display = 'block';
        roomSelectionContainer.innerHTML = '';

        try {
            const response = await fetch(`/api/dorm-state/${dormId}`);
            if (!response.ok) throw new Error('Ошибка сети');
            const rooms = await response.json();

            roomsPlaceholder.style.display = 'none';
            const roomsByCapacity = { 2: [], 3: [] };

            rooms.forEach(room => {
                let roomHTML = `<div class="room-card" data-room-id="${room.id}">
                                    <h4 class="font-semibold text-lg text-center">Комната ${room.number}</h4>
                                    <div class="bed-container">`;

                room.beds.forEach(bed => {
                    let bedClass = bed.status;
                    let bookingData = '';
                    if (bed.booking) {
                        bookingData = `data-booking-id="${bed.booking.id}" data-guest-name="${bed.booking.full_name}"`;
                    }
                    if (bed.status === 'occupied-living') bedClass = 'occupied';
                    else if (bed.status === 'occupied-booked') bedClass = 'bed-booked';
                    else if (bed.status === 'repair') bedClass = 'bed-repair';

                    const bedEl = document.createElement('div');
                    bedEl.className = `bed ${bedClass}`;

                    // Передаем ID
                    if (bookingData) {
                         bedEl.dataset.bookingId = bed.booking.id;
                         bedEl.dataset.guestName = bed.booking.full_name;
                    }
                    // События мыши
                    bedEl.addEventListener('mouseenter', () => showTooltip(bedEl, bed.booking));
                    bedEl.addEventListener('mouseleave', hideTooltip);

                    // КЛИК ПО КРОВАТИ
                    bedEl.addEventListener('click', () => handleBedClick(bedEl));

                    roomHTML += bedEl.outerHTML;
                });
                roomHTML += `</div></div>`;
                if (room.capacity === 2) roomsByCapacity[2].push(roomHTML);
                else roomsByCapacity[3].push(roomHTML);
            });

            let finalHTML = '';
            if (roomsByCapacity[3].length > 0) finalHTML += `<div><h3 class="text-xl font-semibold mb-4 border-b-2"></h3><div class="room-grid">${roomsByCapacity[3].join('')}</div></div>`;
            if (roomsByCapacity[2].length > 0) finalHTML += `<div><h3 class="text-xl font-semibold mb-4 border-b-2"></h3><div class="room-grid">${roomsByCapacity[2].join('')}</div></div>`;
            roomSelectionContainer.innerHTML = finalHTML;

            // Восстанавливаем обработчики кликов после перерисовки HTML
            document.querySelectorAll('.bed').forEach(bed => {
                bed.addEventListener('click', () => handleBedClick(bed));
                // Восстанавливаем тултипы, так как HTML был перезаписан
                 // (Упрощенно: в реальном проекте лучше использовать делегирование событий, но здесь оставим так)
                 if(bed.dataset.bookingId) {
                     // Тултипы тут сложно восстановить без данных, но клик важнее
                 }
            });

        } catch (error) {
            roomsPlaceholder.textContent = `Ошибка: ${error.message}`;
        }
    }

    // Обработчик клика вынесен отдельно
    function handleBedClick(bed) {
        const bookingId = bed.dataset.bookingId;

        if (bookingId) {
            // Если кликнули по занятой кровати
            selectedBookingToMove = bookingId;
            const guestName = bed.dataset.guestName;

            // Визуальное выделение
            document.querySelectorAll('.bed').forEach(b => b.classList.remove('selected-for-move'));
            bed.classList.add('selected-for-move');

            // Показываем панель действий
            guestNameEl.textContent = guestName;
            moveGuestLink.href = `/move-booking/${bookingId}`;

            // Показываем панель
            statusBar.classList.remove('hidden');
        } else {
           // Если кликнули по пустой - скрываем
           cancelMove();
        }
    }

    function cancelMove() {
        selectedBookingToMove = null;
        statusBar.classList.add('hidden');
        document.querySelectorAll('.bed').forEach(b => b.classList.remove('selected-for-move'));
    }

    // --- НОВАЯ ЛОГИКА: ОБРАБОТЧИК КНОПКИ "ВЫСЕЛИТЬ" ---
    btnEvictGuest.addEventListener('click', async () => {
        if (!selectedBookingToMove) return;

        const name = guestNameEl.textContent;
        const confirmMsg = `Вы действительно хотите ДОСРОЧНО выселить гостя ${name}?\n\nМесто станет свободным с сегодняшнего дня.`;

        if (confirm(confirmMsg)) {
            try {
                const response = await fetch('/api/evict-early', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ booking_id: selectedBookingToMove })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    cancelMove(); // Скрыть панель
                    renderDormState(DORM_ID); // Обновить карту (кровать станет зеленой)
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (err) {
                alert('Ошибка сервера при выселении.');
            }
        }
    });

    // --- ИНИЦИАЛИЗАЦИЯ ---
    renderDormState(DORM_ID);
    cancelMoveBtn.addEventListener('click', cancelMove);

    if (dormSwitcher) {
        dormSwitcher.addEventListener('change', (e) => {
            window.location.href = `{{ url_for('commandant_panel') }}?dorm_id=${e.target.value}`;
        });
    }
});
</script>
{% endblock %}