{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-8">Наши общежития</h1>
<div class="space-y-10">
    {% for dorm in dorms %}
    <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-rzd-red mb-4">{{ dorm.name }}</h2>

        <div class="relative w-full h-48 bg-gray-100 rounded-xl overflow-hidden mb-6 group dorm-slider" id="slider-container-{{ dorm.id }}">

            <div class="flex h-full transition-transform duration-500 ease-out" id="track-{{ dorm.id }}">

                {% for i in range(1, 11) %} <div class="w-1/3 flex-shrink-0 h-full p-1 dorm-slide-wrapper">
                     <img src="{{ url_for('static', filename='dorms/dorm_' ~ dorm.id ~ '_' ~ i ~ '.jpg') }}"
                         class="w-full h-full object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-90 transition-opacity"
                         onclick="openFullscreen(this.src)"
                         onerror="this.closest('.dorm-slide-wrapper').remove()"
                         onload="initSlider('{{ dorm.id }}')">
                </div>
                {% endfor %}

            </div>

            <div class="no-photo-placeholder absolute inset-0 flex items-center justify-center text-gray-400 hidden pointer-events-none">
                Нет фотографий
            </div>

            <button onclick="moveCarousel('{{ dorm.id }}', -1)"
                    class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 text-gray-800 p-2 rounded-full hover:bg-white shadow-md transition opacity-0 group-hover:opacity-100 z-10 focus:outline-none">
                <ion-icon name="chevron-back-outline" class="text-xl"></ion-icon>
            </button>

            <button onclick="moveCarousel('{{ dorm.id }}', 1)"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 text-gray-800 p-2 rounded-full hover:bg-white shadow-md transition opacity-0 group-hover:opacity-100 z-10 focus:outline-none">
                <ion-icon name="chevron-forward-outline" class="text-xl"></ion-icon>
            </button>
        </div>
        <p class="text-lg mb-2"><strong>Яндекс.Карты:</strong> {{ dorm.address }}</p>
        <p class="text-lg mb-2"><strong>2ГИС:</strong> {{ dorm.description }}</p>


        <div class="h-64 bg-gray-100 rounded-lg overflow-hidden shadow-inner border border-gray-300">
            <iframe
                src="https://yandex.ru/map-widget/v1/?text={{ dorm.address }}&z=18"
                width="100%"
                height="100%"
                frameborder="0"
                allowfullscreen="true">
            </iframe>
        </div>

        </div>

    {% else %}
    <p>Информация об общежитиях пока не добавлена.</p>
    {% endfor %}
    <div id="fullscreen-modal"
         class="fixed inset-0 z-50 hidden bg-black bg-opacity-90 flex items-center justify-center p-4 transition-opacity duration-300"
         onclick="closeFullscreen()">

        <button class="absolute top-5 right-5 text-white text-5xl hover:text-gray-400 focus:outline-none z-50 leading-none">
            &times;
        </button>

        <img id="fullscreen-image"
             src=""
             class="max-h-full max-w-full object-contain rounded shadow-2xl transform scale-95 transition-transform duration-300"
             onclick="event.stopPropagation()">
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    // Хранилище текущих позиций: { '1': 0, '2': 3 }
    const carouselState = {};

    function initSlider(dormId) {
        // Проверяем, остались ли картинки после удаления битых
        const track = document.getElementById(`track-${dormId}`);
        const slides = track.querySelectorAll('.dorm-slide-wrapper');
        const container = document.getElementById(`slider-container-${dormId}`);
        const placeholder = container.querySelector('.no-photo-placeholder');

        if (slides.length === 0) {
            placeholder.classList.remove('hidden');
        } else {
            placeholder.classList.add('hidden');
        }
    }

    function moveCarousel(dormId, direction) {
        // Инициализируем состояние
        if (carouselState[dormId] === undefined) carouselState[dormId] = 0;

        const track = document.getElementById(`track-${dormId}`);
        const slides = track.querySelectorAll('.dorm-slide-wrapper');
        const totalSlides = slides.length;

        // Сколько картинок мы видим одновременно
        const visibleSlides = 3;

        // Если картинок меньше 3, двигать нечего
        if (totalSlides <= visibleSlides) return;

        // Вычисляем новый индекс
        let newIndex = carouselState[dormId] + direction;

        // Ограничиваем движение:
        // Нельзя уйти левее 0
        if (newIndex < 0) newIndex = 0;

        // Нельзя уйти правее, чем (Всего - Видимые)
        // Например, если 5 фото, то максимальный индекс сдвига = 5 - 3 = 2.
        // Тогда мы увидим фото 3, 4, 5.
        const maxIndex = totalSlides - visibleSlides;
        if (newIndex > maxIndex) newIndex = maxIndex;

        // Сохраняем и двигаем
        carouselState[dormId] = newIndex;

        // Сдвиг в процентах: Индекс * (100% / 3)
        const percent = -(newIndex * (100 / visibleSlides));
        track.style.transform = `translateX(${percent}%)`;
    }
    // --- ФУНКЦИИ ПРОСМОТРА ФОТО ---

    function openFullscreen(imageSrc) {
        const modal = document.getElementById('fullscreen-modal');
        const img = document.getElementById('fullscreen-image');

        // Устанавливаем картинку
        img.src = imageSrc;

        // Показываем окно
        modal.classList.remove('hidden');

        // Небольшая анимация появления (через таймаут, чтобы CSS успел отработать)
        setTimeout(() => {
            img.classList.remove('scale-95');
            img.classList.add('scale-100');
        }, 10);
    }

    function closeFullscreen() {
        const modal = document.getElementById('fullscreen-modal');
        const img = document.getElementById('fullscreen-image');

        // Скрываем окно
        modal.classList.add('hidden');
        img.classList.remove('scale-100');
        img.classList.add('scale-95');

        // Очищаем src, чтобы не моргало при следующем открытии
        setTimeout(() => { img.src = ''; }, 300);
    }

    // Закрытие по кнопке Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeFullscreen();
        }
    });
</script>
{% endblock %}